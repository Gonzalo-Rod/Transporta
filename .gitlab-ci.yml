.default_rules: &default_rules
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
  - if: "$CI_COMMIT_BRANCH =~ $DEV_BRANCH_REGEX"
  - if: "$CI_COMMIT_BRANCH =~ $QA_BRANCH_REGEX"
  - if: "$CI_COMMIT_BRANCH =~ $PROD_BRANCH_REGEX"

.dev_only_rules: &dev_only_rules
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ $DEV_BRANCH_REGEX'
  - if: "$CI_COMMIT_BRANCH =~ $DEV_BRANCH_REGEX"

.dev_qa_rules: &dev_qa_rules
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ $DEV_BRANCH_REGEX || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ $QA_BRANCH_REGEX)'
  - if: "$CI_COMMIT_BRANCH =~ $DEV_BRANCH_REGEX || $CI_COMMIT_BRANCH =~ $QA_BRANCH_REGEX"

stages:
  - google_code_style
  - frontend_build
  - backend_build
  - api_install
  - api_lint
  - sonar
  - api_test
  - backend_test

variables:
  GIT_DEPTH: "0"
  GIT_SUBMODULE_STRATEGY: recursive
  DEV_BRANCH_REGEX: "^dev(elop)?$"
  QA_BRANCH_REGEX: "^qa$"
  PROD_BRANCH_REGEX: "^(main|master|prod(uction)?)$"

frontend_tests:
  image: node:18
  stage: frontend_build
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  script:
    - npm ci --prefer-offline
    - npm run test -- --coverage
  artifacts:
    when: always
    paths:
      - coverage/lcov.info
    expire_in: 1 day
  rules: *default_rules

frontend_lint:
  image: node:18
  stage: google_code_style
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  script:
    - npm ci --prefer-offline
    - mkdir -p reports
    - LINT_EXIT=0
    - npm run lint -- --format junit --output-file reports/eslint-report.xml || LINT_EXIT=$?
    - |
      if [ "$LINT_EXIT" -ne 0 ]; then
        echo "Lint issues found. Review reports/eslint-report.xml for details."
      else
        echo "Lint completed with no errors."
      fi
  artifacts:
    when: always
    paths:
      - reports/eslint-report.xml
    reports:
      junit: reports/eslint-report.xml
  rules: *dev_only_rules

backend_tests:
  image:
    name: node:18
    entrypoint: [""]
  stage: backend_build
  variables:
    SERVICES: "get_user login register reservas vehiculos"
  script:
    - |
      set -e
      for service in $SERVICES; do
        echo "Installing and testing backend service: ${service}"
        (cd backend/"${service}" && npm ci --prefer-offline && npm run test -- --coverage)
      done
    - mkdir -p backend/coverage
    - rm -f backend/coverage/lcov-all.info
    - |
      missing=0
      for service in $SERVICES; do
        coverage_file="backend/${service}/coverage/lcov.info"
        if [ -f "$coverage_file" ]; then
          cat "$coverage_file" >> backend/coverage/lcov-all.info
          printf "\n" >> backend/coverage/lcov-all.info
        else
          echo "Coverage file missing for ${service}: ${coverage_file}" >&2
          missing=1
        fi
      done
      if [ "$missing" -ne 0 ]; then
        echo "One or more backend coverage reports are missing." >&2
        exit 1
      fi
  artifacts:
    when: always
    paths:
      - backend/coverage/lcov-all.info
      - backend/**/coverage/
    expire_in: 1 week
  rules: *default_rules

autotransporta_install_deps:
  image: node:18
  stage: api_install
  cache:
    key: ${CI_COMMIT_REF_SLUG}-autotransporta
    paths:
      - autotransporta/node_modules/
    policy: pull-push
  script:
    - cd autotransporta
    - npm ci --include=dev
  artifacts:
    paths:
      - autotransporta/node_modules/
    expire_in: 1 week
  rules: *default_rules

spectral_lint:
  image: node:18
  stage: api_lint
  needs:
    - autotransporta_install_deps
  script:
    - cd autotransporta
    - LINT_EXIT=0
    - npm run lint:api || LINT_EXIT=$?
    - npm run lint:api:sarif || LINT_EXIT=$?
    - npm run lint:api:html || LINT_EXIT=$?
    - exit $LINT_EXIT
  artifacts:
    when: always
    paths:
      - autotransporta/reports/spectral.sarif
      - autotransporta/reports/spectral.html
    reports:
      sast: autotransporta/reports/spectral.sarif
  rules: *default_rules

sonarqube_scan:
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  stage: sonar
  needs:
    - frontend_tests
  script:
    - |
      frontend_host="${SONAR_FRONTEND_HOST_URL:-$SONAR_HOST_URL}"
      if [ -z "${frontend_host}" ]; then
        echo "SONAR_FRONTEND_HOST_URL or SONAR_HOST_URL must be set for the frontend scan." >&2
        exit 1
      fi
      if [ -z "${SONAR_FRONTEND_TOKEN}" ] && [ -z "${SONAR_TOKEN}" ] && [ -z "${SONAR_LOGIN}" ]; then
        echo "Please define SONAR_FRONTEND_TOKEN (preferred) or SONAR_TOKEN / SONAR_LOGIN for the frontend scan." >&2
        exit 1
      fi
      sonar_login_value="${SONAR_FRONTEND_TOKEN:-${SONAR_TOKEN:-$SONAR_LOGIN}}"
      sonar-scanner \
        -Dsonar.host.url="${frontend_host}" \
        -Dsonar.login="${sonar_login_value}"
  rules: *dev_only_rules

sonarqube_backend_scan:
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  stage: sonar
  needs:
    - backend_tests
  script:
    - |
      backend_host="${SONAR_BACKEND_HOST_URL:-$SONAR_HOST_URL}"
      if [ -z "${backend_host}" ]; then
        echo "SONAR_BACKEND_HOST_URL or SONAR_HOST_URL must be set for the backend scan." >&2
        exit 1
      fi
      if [ -z "${SONAR_BACKEND_TOKEN}" ] && [ -z "${SONAR_TOKEN}" ] && [ -z "${SONAR_LOGIN}" ]; then
        echo "Please define SONAR_BACKEND_TOKEN (preferred) or SONAR_TOKEN / SONAR_LOGIN for the backend scan." >&2
        exit 1
      fi
      sonar_login_value="${SONAR_BACKEND_TOKEN:-${SONAR_TOKEN:-$SONAR_LOGIN}}"
      sonar-scanner \
        -Dsonar.host.url="${backend_host}" \
        -Dsonar.login="${sonar_login_value}" \
        -Dproject.settings=backend/sonar-project.properties
  rules: *dev_only_rules

newman_tests:
  image: node:18
  stage: api_test
  needs:
    - autotransporta_install_deps
  script:
    - cd autotransporta
    - npm run test:api
  artifacts:
    when: always
    paths:
      - autotransporta/reports/newman.xml
    reports:
      junit: autotransporta/reports/newman.xml
  rules: *dev_qa_rules

jmeter_backend_tests:
  image:
    name: justb4/jmeter:latest
    entrypoint: [""]
  stage: backend_test
  variables:
    JMETER_TEST_PLAN: jmeter/apitest.jmx
  script:
    - mkdir -p results/report
    - |
      jmeter -n \
        -t "${JMETER_TEST_PLAN}" \
        -l results/jmeter-results.jtl \
        -e -o results/report
  artifacts:
    when: always
    paths:
      - results/jmeter-results.jtl
      - results/report
    expire_in: 1 week
  rules: *default_rules
